using LitJson;
using System.Collections;
using System.Collections.Generic;
using TMPro;
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;

public class DialogUI : MonoBehaviour
{
    private int dialogIndex;
    private int currentLine;
    private Dialog dialog;
    private Define.EventType dialogType;
    private RoomSymbol talkingSymbol;
    private ButtonEvents buttonEvents;

    private Image portrait;
    private TMP_Text nameText;
    private TMP_Text lineText;


    private void Awake()
    {
        buttonEvents = GetComponent<ButtonEvents>();
        portrait = GameObject.Find("Portrait").GetComponent<Image>();
        nameText = transform.GetChild(1).Find("Name").Find("NameText").GetComponent<TMP_Text>();
        lineText = transform.GetChild(1).Find("Line").Find("LineText").GetComponent<TMP_Text>();
    }

    private void OnEnable()
    {
        currentLine = 0;

        InputManager.Instance.KeyActions.Player.Disable();
        InputManager.Instance.KeyActions.UI.Enable();

        //엔터, 마우스 클릭으로 대화창 진행하는 함수 실행하게 이벤트 등록
        //인풋시스템에 이벤트 함수 등록할 때, 람다로 등록하지 않는 게 좋을 듯. 왠지는 모르겠는데 중복 실행 오류난다
        InputManager.Instance.KeyActions.UI.Check.started += ProgressDialogByCheck;
        buttonEvents.PointerDown += context => { ProgressDialog(); };
    }

    private void OnDisable()
    {
        //이벤트 해제, 플레이어 조작 활성화
        InputManager.Instance.KeyActions.Player.Enable();
        InputManager.Instance.KeyActions.UI.Disable();

        InputManager.Instance.KeyActions.UI.Check.started -= ProgressDialogByCheck;
        buttonEvents.PointerDown -= context => { ProgressDialog(); };
    }

    //처음 대화창을 여는 함수
    public void ShowDialog(RoomSymbol symbol)
    {
        talkingSymbol = symbol;
        dialogIndex = symbol.Index;
        dialogType = symbol.SymbolType;
        currentLine = 0;
        ProgressDialog();
    }

    //대화창을 진행시키는 함수. JSON에서 대화 내용을 가져오고, 더이상 없으면 대화창을 닫는다.
    //카운터를 올려서 다음에는 다음 대화 내용이 출력되도록 함.
    //대화 내용에 따라 UI와 포트레이트를 변경.
    public void ProgressDialog()
    {
        dialog = DialogManager.Instance.GetLine(dialogIndex, currentLine);
        if (dialog == null) 
        {
            Debug.Log("대화 종료");
            AssetLoader.Instance.Destroy(talkingSymbol.gameObject);
            PanelManager.Instance.ClosePanel("DialogUI");
            return;
        }

        portrait.sprite = DialogManager.Instance.GetSprite(dialog.portrait);
        nameText.text = dialog.name;
        lineText.text = dialog.line;

        currentLine++;
    }

    public void ProgressDialogByCheck(InputAction.CallbackContext context)
    {
        ProgressDialog();
    }

}
